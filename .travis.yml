dist: trusty
language: go
os: linux

go:
  - 1.15.x
  - 1.14.x
  - tip

jobs:
  fast_finish: true
  allow_failures:
    - go: tip

# skip non-trunk PMM-XXXX branch builds, but still build pull requests
branches:
  except:
    - /^PMM\-\d{4}/

env:
  global:
    # REVIEWDOG_GITHUB_API_TOKEN
    - secure: sm+fjrkgWFOypC87OnxBek9BnZp9ezOndg/sh+NecUGm48Ux2Wf/wbaHVXysDCekW08aapnma7GSVJUngEREvaJ/9s4NrDVcBYvuvwYcSS/M2tdhiPkUFM+P8D4Xu7pVJU/ZOHej+t7D8u79oF9FzU2T2JLLYgwMh6tA2lmpt9gVOnv1jWAmqCvznL02GS6OxfcFuJHDtrbYgaKNa1UEbKtewmWvLkDwTShdlJfqdqvFxoyxEcJYisOnMLxH3q4So3PeGp4ehyP4zodtyTOZAVLdu1x8sYtrzcA5p/z3u/m3BYk+hUV7nX7choPbTKgg3SI/GMvlXmxsQDvjNXATskGe1dRy6wxGdIYALFWAuDIDX4hQkLG7mKRJ55Wu1kEPGb/liCJo3XQ/+6Xl7F7Kd2bNO4cR+dXhf6AIVnn2BUeezXEmzouDNTus8nzgSVTz0IKK/QNCZHLvuzoqBw6gpiJnWXz21jQucM3ADIqqU+z8fNINbZu2amc8e53mXRDtGXEe/rnDLqb6WPfJWt/YpSaqJobMZ/mVOBv68b9C1rauKhMqeVwUSp6Qb/UWkOMrpDY2KDbR3qR9yrAftKMcvN1/FKVInjgR+ITPt5qvbnOxCYlTTBaKnXSUjCkrjamvGVlLREpM1RBpndjfzr8wEWXvu0zzcrlWupPXpR2WEtI=

  jobs:
    - MYSQL_IMAGE=mysql/mysql-server:5.5
    - MYSQL_IMAGE=mysql/mysql-server:5.6
    - MYSQL_IMAGE=mysql/mysql-server:5.7
    - MYSQL_IMAGE=mysql/mysql-server:8.0
    - MYSQL_IMAGE=mariadb:5.5
    - MYSQL_IMAGE=mariadb:10.0
    - MYSQL_IMAGE=mariadb:10.1
    - MYSQL_IMAGE=mariadb:10.2
    - MYSQL_IMAGE=mariadb:10.3
    - MYSQL_IMAGE=percona/percona-server:5.6
    - MYSQL_IMAGE=percona/percona-server:5.7
    - MYSQL_IMAGE=percona/percona-server:8.0
    - MYSQL_IMAGE=percona:5.5
    - MYSQL_IMAGE=percona:5.6
    - MYSQL_IMAGE=percona:5.7
    - MYSQL_IMAGE=percona:8.0

services:
  - docker

go_import_path: github.com/percona/mysqld_exporter

install:
  # install reviewdog and golangci-lin
  - curl https://raw.githubusercontent.com/reviewdog/reviewdog/master/install.sh| sh -s
  - curl https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s latest

before_script:
  # static analyze
  - bin/golangci-lint run -c=.golangci-required.yml --out-format=line-number | bin/reviewdog -f=golangci-lint -level=error -reporter=github-pr-check
  - bin/golangci-lint run -c=.golangci.yml --out-format=line-number | bin/reviewdog -f=golangci-lint -level=error -reporter=github-pr-review
  - sudo service mysql stop
  - docker --version
  - docker-compose --version
  - docker-compose up -d

script:
  - make all
  - make test

notifications:
  email: false
